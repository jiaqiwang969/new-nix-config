#!/usr/bin/env bash
# NixOS å®‰è£…æ­¥éª¤é€ŸæŸ¥å¡

cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           NixOS è™šæ‹Ÿæœºå®‰è£…é€ŸæŸ¥å¡ - vm-dev-1                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ è™šæ‹Ÿæœºä¿¡æ¯
  IP åœ°å€: 192.168.64.13
  ä¸»æœºå: nixos-vm-dev-1
  ç”¨æˆ·å: jqwang

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨è™šæ‹Ÿæœºåï¼Œè®¾ç½® root å¯†ç 
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

åœ¨ VM ç»ˆç«¯ä¸­æ‰§è¡Œï¼š

  sudo su
  passwd
  # è¾“å…¥å¯†ç : root

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬äºŒæ­¥ï¼šç£ç›˜åˆ†åŒº
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# æŸ¥çœ‹ç£ç›˜
lsblk

# åˆ†åŒºï¼ˆé€šå¸¸æ˜¯ /dev/vdaï¼‰
parted /dev/vda -- mklabel gpt
parted /dev/vda -- mkpart primary 512MB -8GB
parted /dev/vda -- mkpart primary linux-swap -8GB 100%
parted /dev/vda -- mkpart ESP fat32 1MB 512MB
parted /dev/vda -- set 3 esp on

# æ ¼å¼åŒ–
mkfs.ext4 -L nixos /dev/vda1
mkswap -L swap /dev/vda2
mkfs.fat -F 32 -n boot /dev/vda3

# æŒ‚è½½
mount /dev/disk/by-label/nixos /mnt
mkdir -p /mnt/boot
mount /dev/disk/by-label/boot /mnt/boot
swapon /dev/vda2

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆé…ç½®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

nixos-generate-config --root /mnt

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬å››æ­¥ï¼šç¼–è¾‘é…ç½®æ–‡ä»¶
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

nano /mnt/etc/nixos/configuration.nix

åœ¨ system.stateVersion ä¹‹å‰æ·»åŠ ï¼š

  # Nix Flakes
  nix.package = pkgs.nixVersions.latest;
  nix.extraOptions = ''
    experimental-features = nix-command flakes
  '';

  # ç½‘ç»œé…ç½® - é™æ€ IP
  networking.interfaces.enp0s10 = {
    useDHCP = false;
    ipv4.addresses = [{
      address = "192.168.64.13";
      prefixLength = 24;
    }];
  };
  networking.defaultGateway = "192.168.64.1";
  networking.nameservers = [ "192.168.64.1" "8.8.8.8" ];
  networking.hostName = "nixos-vm-dev-1";

  # SSH
  services.openssh.enable = true;
  services.openssh.settings.PasswordAuthentication = true;
  services.openssh.settings.PermitRootLogin = "yes";

  # ç”¨æˆ·
  users.users.root.initialPassword = "root";
  users.users.jqwang = {
    isNormalUser = true;
    extraGroups = [ "wheel" "networkmanager" "docker" ];
    initialPassword = "jqwang";
  };

  # Sudo æ— å¯†ç 
  security.sudo.wheelNeedsPassword = false;

  # SPICE æ”¯æŒï¼ˆUTMï¼‰
  services.spice-vdagentd.enable = true;

  # è½¯ä»¶æ¸²æŸ“ï¼ˆM1 Macï¼‰
  environment.variables.LIBGL_ALWAYS_SOFTWARE = "1";

  # å…è®¸ä¸å—æ”¯æŒçš„ç³»ç»Ÿ
  nixpkgs.config.allowUnfree = true;
  nixpkgs.config.allowUnsupportedSystem = true;

ä¿å­˜: Ctrl+X, Y, Enter

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬äº”æ­¥ï¼šå®‰è£…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

nixos-install --no-root-passwd

# ç­‰å¾…å®‰è£…å®Œæˆï¼ˆ10-30 åˆ†é’Ÿï¼‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬å…­æ­¥ï¼šé‡å¯å‰ç§»é™¤ ISO
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸  åœ¨ UTM ä¸­ï¼š
  1. ç‚¹å‡»è™šæ‹Ÿæœºè®¾ç½®ï¼ˆé½¿è½®å›¾æ ‡ï¼‰
  2. æ‰¾åˆ° CD/DVD é©±åŠ¨å™¨
  3. ç‚¹å‡» "Clear" ç§»é™¤ ISO

ç„¶ååœ¨ VM ä¸­æ‰§è¡Œï¼š

  reboot

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬ä¸ƒæ­¥ï¼šé¦–æ¬¡ç™»å½•
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç”¨æˆ·å: jqwang
å¯†ç : jqwang

éªŒè¯ç½‘ç»œï¼š

  ip addr show enp0s10
  # åº”è¯¥æ˜¾ç¤º 192.168.64.13

  ping -c 3 8.8.8.8
  # æµ‹è¯•äº’è”ç½‘è¿æ¥

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬å…«æ­¥ï¼šä» macOS éƒ¨ç½²é…ç½®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

åœ¨ macOS ç»ˆç«¯ä¸­ï¼š

  cd /Users/jqwang/00-nixos-config/nixos-config

  # æµ‹è¯•è¿æ¥
  ping -c 3 192.168.64.13

  # SSH è¿æ¥æµ‹è¯•
  ssh jqwang@192.168.64.13

  # éƒ¨ç½²é…ç½®
  ./manage-vms.sh deploy vm-dev-1

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å®Œæˆï¼ğŸ‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

åç»­æ­¥éª¤ï¼š
  â€¢ é…ç½® SSH å¯†é’¥: ssh-copy-id jqwang@192.168.64.13
  â€¢ ç”Ÿæˆ SSH é…ç½®: ./manage-vms.sh generate-ssh-config
  â€¢ æ›´æ–° hosts: ./manage-vms.sh update-hosts
  â€¢ åˆ›å»ºæ›´å¤š VM: ./manage-vms.sh create vm-dev-2

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

EOF
